# Working with AWS CLI - Notesheet <!-- omit in toc -->

## Table of Contents <!-- omit in toc -->

- [AWS Fundamentals and Best Practices](#aws-fundamentals-and-best-practices)
- [CLI Configuration](#cli-configuration)
  - [Initial setup](#initial-setup)
  - [Allow AWS CLI v2 to load JSON events from a file](#allow-aws-cli-v2-to-load-json-events-from-a-file)
  - [Install the AWS SAM CLI](#install-the-aws-sam-cli)
- [Using AWS Lambda with the AWS CLI](#using-aws-lambda-with-the-aws-cli)
  - [Create roles with as few privileges as necessary](#create-roles-with-as-few-privileges-as-necessary)
  - [Create a Lambda function from a deployment package](#create-a-lambda-function-from-a-deployment-package)
  - [Invoke a Lambda function directly](#invoke-a-lambda-function-directly)
  - [Invoke and retrieve logs for a Lambda function from a shell script](#invoke-and-retrieve-logs-for-a-lambda-function-from-a-shell-script)
  - [Delete a Lambda function](#delete-a-lambda-function)
  - [Remove redundant IAM roles](#remove-redundant-iam-roles)
- [Using DynamoDB Locally via the CLI](#using-dynamodb-locally-via-the-cli)
  - [Query for specific items](#query-for-specific-items)
- [Using the SAM / CloudFormation CLI to Build Serverless Applications](#using-the-sam--cloudformation-cli-to-build-serverless-applications)
  - [Considerations if using SAM alongside Docker Toolbox](#considerations-if-using-sam-alongside-docker-toolbox)
  - [Initialize a new SAM application](#initialize-a-new-sam-application)
  - [Host an API Gateway locally](#host-an-api-gateway-locally)
  - [Invoke a Lambda function locally](#invoke-a-lambda-function-locally)
  - [Inspect and monitor logs generated by stack functions](#inspect-and-monitor-logs-generated-by-stack-functions)
  - [Passing custom and runtime-only values into a template](#passing-custom-and-runtime-only-values-into-a-template)
  - [Deduplicate common resource configuration](#deduplicate-common-resource-configuration)
  - [Deploy a SAM application stack](#deploy-a-sam-application-stack)
  - [Tear down a deployment stack](#tear-down-a-deployment-stack)
- [Using AWS Cognito with the AWS CLI](#using-aws-cognito-with-the-aws-cli)
  - [Show available user pools](#show-available-user-pools)
  - [Create new users](#create-new-users)
  - [Update user group membership](#update-user-group-membership)
- [Using API Gateway with the AWS CLI](#using-api-gateway-with-the-aws-cli)
  - [Create and add JWT authorizers to AWS Gateway V2 (HTTPAPI) routes](#create-and-add-jwt-authorizers-to-aws-gateway-v2-httpapi-routes)

---

## AWS Fundamentals and Best Practices

- [AWS Account Management and Separation](https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/aws-account-management-and-separation.html)
- [AWS Identity and Access Management](https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/identity-and-access-management.html)
- [Security best practices in IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
- [Creating your first IAM admin user and group](https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started_create-admin-group.html)

## CLI Configuration

- [Manage profile credentials](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html)
- [Enable command completion](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-completion.html)

### Initial setup

```shell
aws configure
> AWS Access Key ID [None]: NOTROOTUSER-EXAMPLEUSER
> AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCY-EXAMPLEKEY
> Default region name [None]: us-west-2-EXAMPLEZONE
> Default output format [None]: json-EXAMPLEFORMAT

aws configure list
```

### Allow AWS CLI v2 to load JSON events from a file

```shell
vim ~/.aws/config

# Add the following key:value pair to the config profile
cli_binary_format = raw-in-base64-out
```

### Install the AWS SAM CLI

- <https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html>

## Using AWS Lambda with the AWS CLI

- <https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-awscli.html>

### Create roles with as few privileges as necessary

```json
// -- trust-policy.json

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

```shell
aws iam create-role --role-name lambda-ex \
  --assume-role-policy-document file://trust-policy.json

aws iam attach-role-policy --role-name lambda-ex \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

aws iam update-role --role-name lambda-ex \
  --description "Allows Lambda write access to CloudWatch Logs"

aws iam get-role --role-name lambda-ex
```

### Create a Lambda function from a deployment package

```javascript
// -- index.js

exports.handler = async function (event, context) {
  /**
   * Log the values of environment variables and the event object
   */
  console.log(`ENVIRONMENT VARS:\n${JSON.stringify(process.env, null, 2)}`);
  console.log(`EVENT:\n${JSON.stringify(event, null, 2)}`);

  return context.logStreamName;
};
```

```shell
zip function.zip your_function.zip

aws lambda create-function --function-name test-function \
  --zip-file fileb://function.zip --handler index.handler \
  --runtime nodejs12.x --role arn:aws:iam::<ACCOUNT_ID>:role/lambda-ex

aws lambda list-functions --max-items 10
```

### Invoke a Lambda function directly

```shell
# Logs are base64 encoded
aws lambda invoke --function-name test-function --log-type Tail output

# Specific log keys can be queried and base64 decoded as required
aws lambda invoke --function-name test-function --log-type Tail output \
  --query "LogResult" --output text | base64 -d
```

### Invoke and retrieve logs for a Lambda function from a shell script

```json
// -- payload.json

{ "key": "value" }
```

```bash
# -- get-logs.sh

#!/bin/bash

# ref: https://stackoverflow.com/questions/53654186/
export MSYS_NO_PATHCONV=1

aws lambda invoke --function-name test-function --payload file://payload.json outfile

# Replace double quotes in `outfile` in-place
sed -i'' -e 's|"||g' outfile

printf "%s\n" "Allowing time for logs to be available..."
sleep 10

aws logs get-log-events --log-group-name /aws/lambda/test-function \
  --log-stream-name $(cat outfile) --limit 5 && rm -v outfile
```

### Delete a Lambda function

```shell
aws lambda get-function --function-name test-function
aws lambda delete-function --function-name test-function
```

### Remove redundant IAM roles

- <https://docs.aws.amazon.com/IAM/latest/UserGuide/roles-managingrole-editing-cli.html>

```shell
aws iam list-roles

# Inline policies
aws iam list-role-policies --role-name <ROLENAME>

aws iam delete-role-policy --role-name <ROLENAME> \
  --policy-name AWSLambdaBasicExecutionRole

# Attached policies (Notice: uses full ARN name, not short name as above)
aws iam list-attached-role-policies --role-name <ROLENAME>

aws iam detach-role-policy --role-name <ROLENAME> \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

# Clean up dangling roles
aws iam delete-role --role-name <ROLENAME>
```

## Using DynamoDB Locally via the CLI

- <https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.DownloadingAndRunning.html>
- <https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.UsageNotes.html>

```shell
mkdir dynamodb_local && cd $_
curl -O https://s3.eu-central-1.amazonaws.com/dynamodb-local-frankfurt/dynamodb_local_latest.zip
unzip dynamodb_local_latest.zip

# Display DynamoDB Local usage and options
java -Djava.library.path=./DynamoDBLocal_lib -jar DynamoDBLocal.jar -help

# Create local common database `shared-local-instance.db`
java -Djava.library.path=./DynamoDBLocal_lib -jar DynamoDBLocal.jar -sharedDb

# N.B. Dummy credentials can be used for local deployments of DynamoDB
aws configure
aws dynamodb list-tables --endpoint-url http://localhost:8000
```

### Query for specific items

```shell
aws dynamodb get-item --endpoint-url http://localhost:8000 \
  --table-name <TABLENAME> \
  --key '{"examplePartitionKey": {"N":"0"}, "exampleSortKey": {"S":"2020-09-29"}}'

aws dynamodb query --table-name <TABLENAME> \
  --key-condition-expression "userId = :id and #d between :dstart and :dend" \
  --expression-attribute-names '{ "#d": "date" }' \
  --expression-attribute-values \
  '{":id": {"N":"0"}, ":dstart": {"S":"2019-02-01"}, ":dend": {"S":"2019-03-01"}}'
```

## Using the SAM / CloudFormation CLI to Build Serverless Applications

### Considerations if using SAM alongside Docker Toolbox

- <https://github.com/aws/aws-sam-cli/issues/1126#issuecomment-560058705>
- <https://github.com/aws/aws-sam-cli/issues/1254>

N.B. The Docker Toolbox VM only has access to host files inside the Windows
%HOME% dir. If nothing else works, placing a project folder into %HOME% should
make its files available to SAM.

### Initialize a new SAM application

```shell
sam init
```

### Host an API Gateway locally

```shell
sam local start-api

curl http://127.0.0.1:<PORT>/<ENDPOINT>
```

### Invoke a Lambda function locally

```shell
# Create sample payload events (edit generated event as necessary)
sam local generate-event [SERVICE] > local-event.json

sam build

sam local invoke -e local-event.json <LAMBDA_NAME>
```

### Inspect and monitor logs generated by stack functions

```shell
# Instead of manually checking CloudWatch logs...
sam logs --stack-name <STACK_NAME> --name <LAMBDA_NAME> --tail
```

### Passing custom and runtime-only values into a template

The `Parameters` and `Mappings` sections of a SAM / CloudFormation template can
be used to include custom values.

[Intrinsic
Functions](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference.html)
such as `Ref` and `FindInMap` can pass values not available until deploy time to
designated template properties.

```yaml
# -- template.yml

# ...
Parameters:
  DeploymentEnv:
    Type: String
    Default: staging
    AllowedValues:
      - staging
      - prod
    ConstraintDescription: Value must be either staging or prod.
  ApiStageName:
    Type: String
    Default: api
    Description: API Gateway stage name

Mappings:
  EnvToEndpoint:
    staging:
      PROD: false
      API_URL: <STAGING_ENDPOINT_URL>
    prod:
      PROD: true
      API_URL: <PROD_ENDPOINT_URL>

Resources:
  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      OpenApiVersion: 3.0.1
      StageName: !Ref ApiStageName
  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      # ...
      Environment:
        Variables:
          STAGE: !Ref DeploymentEnv
          PROD: !FindInMap [EnvToEndpoint, !Ref DeploymentEnv, PROD]
          API_URL: !FindInMap [EnvToEndpoint, !Ref DeploymentEnv, API_URL]
          TABLE_NAME: !Ref MyDDBTable
      Events:
        getEndpoint:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /
            Method: GET
      Policies:
        - DynamoDBReadPolicy
            TableName: !Ref MyDDBTable
  MyDDBTable:
    Type: AWS::DynamoDB::Table
    # ...
#...
Outputs:
  MyFunctionApiURL:
    Description: The API Gateway URL to invoke MyFunction
    Value: !Sub https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/${ApiStageName}/
```

### Deduplicate common resource configuration

Improve template DRY factor by placing common resource configuration into `Globals`.

```yaml
# -- template.yml

# ...
# Properties here are inherited, and can be overridden, by all associated resources
Globals:
  Function:
    Runtime: nodejs12.x
    Handler: index.handler
    Timeout: 180
    Environment:
      Variables:
        # ...
# ...
```

### Deploy a SAM application stack

When `sam deploy` is called, SAM takes the deployment artifacts created by the
most recent `sam build`, packages and uploads them to an AWS S3 bucket - then
deploys the application using AWS CloudFormation.

```shell
# Initially deploys to production environment by default
sam deploy

# Override default deployment locations
vim samconfig.toml
> stack_name = <staging_env_name>
> s3_prefix = <staging_env_name>
> :wq

# Now deploys to staging environment by default
sam deploy

# Explicitly name stack to deploy to production environment
sam deploy --stack-name <prod_env_name> --s3-prefix <prod_env_name>

# Pass parameter values into the stack template as required
sam deploy --stack-name <prod_env_name> --s3-prefix <prod_env_name> \
  --parameter-overrides <key_1>=<val_1> <key_2>=<val_2>
```

### Tear down a deployment stack

```shell
aws cloudformation delete-stack --stack-name <NAME> --region <REGION>
```

## Using AWS Cognito with the AWS CLI

### Show available user pools

```shell
aws cognito-idp list-user-pools --max-results <INTEGER>
```

### Create new users

```shell
# For open sign-up user pools
aws cognito-idp sign-up \
    --region <REGION> --client-id <CLIENT_ID> \
    --username <EMAIL> --password <PASSWORD> \
    --user-attributes Name=email,Value=<EMAIL>

aws cognito-idp admin-confirm-sign-up \
    --user-pool-id <POOL_ID> --username <EMAIL>

# For admin only sign-up user pools
aws cognito-idp admin-create-user \
    --user-pool-id <POOL_ID> --username <EMAIL>

aws cognito-idp admin-set-user-password \
    --user-pool-id <POOL_ID> --username <EMAIL> --password <PASSWORD> --permanent
```

### Update user group membership

```shell
aws cognito-idp admin-add-user-to-group \
   --user-pool-id <POOL_ID> --username <EMAIL> --group-name <NAME>

aws cognito-idp admin-remove-user-from-group \
   --user-pool-id <POOL_ID> --username <EMAIL> --group-name <NAME>
```

## Using API Gateway with the AWS CLI

### Create and add JWT authorizers to AWS Gateway V2 (HTTPAPI) routes

```shell
# Using AWS Cognito as an identity provider
aws apigatewayv2 create-authorizer \
    --api-id <API_ID> \
    --authorizer-type JWT \
    --name <AUTHORIZER_NAME> \
    --identity-source '$request.header.Authorization' \
    --jwt-configuration \
  Audience=<CLIENT_ID>,Issuer=https://cognito-idp.<REGION>.amazonaws.com/<POOL_ID>

> {
>     "AuthorizerId": "<AUTHORIZER_ID>",
>     "AuthorizerType": "JWT",
>     "IdentitySource": [
>         "$request.header.Authorization"
>     ],
>     "JwtConfiguration": {
>         "Audience": [
>             "<CLIENT_ID>"
>         ],
>         "Issuer": "<ISSUER>"
>     },
>     "Name": "<AUTHORIZER_NAME>"
> }


# For each route requiring auth
aws apigatewayv2 update-route \
   --api-id <API_ID> \
   --authorizer-id <AUTHORIZER_ID> \
   --authorization-type JWT \
   --authorization-scopes <SCOPE_1> <SCOPE_N> \
   --route-id <ROUTE_ID>
```
